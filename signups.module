<?php
/**
 * @file
 * handle some stuff related to signing up for classes and volunteer
 * assignments
 */

/**
 * implementation of hook_help()
 */
function signups_help ($path, $arg) {
  if ($path == 'admin/help#schedule') {
    $txt = 'This module handles some stuff related to signing '.
           'up for classes and volunteer assignments.';
    return '<p>'. t($txt) .'</p>';
  }
}

/**
 * Implementation of hook_menu()
 */
function signups_menu () {
   // a page for checking existing signups
   $items['admin/signups_check'] = array(
   	 'title' => 'Check Signups',
     'page callback' => '_check_signups',
     'access arguments' => array('administer site configuration'),
     'type' => MENU_CALLBACK,
   );

   return $items;
}

/**
 * start the work of checking that everyone has an assignment
 * every period
 */
function _check_signups () {
  // get the default session for new courses to use as the current session
  module_load_include('inc', 'content', 'includes/content.crud');
  $fields = content_field_instance_read(array('type_name' => 'course',
                                              'field_name' => 'field_course_session'));
  $session_nid = $fields[0]['widget']['default_value'][0]['nid'];

  // get the list of all paid member families
  $query = db_query('SELECT node.nid AS family_nid, '.
                    'node.title AS family_name '.
                    'FROM {node} AS node '.
                    'INNER JOIN {users_roles} as roles '.
                    'ON node.uid=roles.uid '.
                    'WHERE type=\'family\' AND rid=8 '.
                    'ORDER BY node.title ASC');
  $signups = array();
  // loop through all paid families
  while ($row = db_fetch_array($query)) {
    // generate the schedule for this family (could probably have made a query to do
    // this all at once, but don't see the point
    $signups[$row['family_name']] = _signups_get_schedule_family($session_nid, $row['family_nid']);
  }
  return _signups_print_page($signups);
}

/**
 * get the schedule for one family (including course signups and jobs)
 * @param int $session_nid the node id of the session
 * @param int $family_nid the node id of the family in question
 * @return an array containing the signup information for this family -- with one
 *         entry for each person, indexed by their name
 */
function _signups_get_schedule_family ($session_nid, $family_nid) {
  $signups = array();
  // first, get all people in this family that need an assignment each period
  $query = db_query('SELECT node.nid AS person_nid, '.
                    'node.title AS name '.
                    'FROM {node} AS node '.
                    'JOIN {content_field_person_family} AS family '.
                    'ON node.vid = family.vid '.
                    'JOIN {content_field_person_no_assignment} AS gone '.
                    'ON node.vid = gone.vid '.
                    'WHERE (type=\'child\' or type=\'adult\') '.
                    'AND gone.field_person_no_assignment_value = \'No\' '.
                    'AND family.nid=node.nid AND field_person_family_nid='. $family_nid .' '.
                    'ORDER BY node.title ASC');
  // each person is a row
  while ($row = db_fetch_array($query)) {
    $signups[$row['name']] = _signups_get_schedule_person($session_nid, $row['person_nid']);
  }
  return $signups;
}

/**
 * get the schedule for one person, including course signups and volunteer signups
 * @param int $session_nid the node id of the session
 * @param int $person_nid the node id of the person
 * @return array the information for this person in the form of an array with one element for each period
 */
function _signups_get_schedule_person ($session_nid, $person_nid) {
  $signups = array();

  // *****************************
  // START WITH THE COURSE SIGNUPS

  $select = 'SELECT signup_course_field.field_signup_course_nid AS course_nid, '.
            'signup_node.nid AS signup_nid ';
  $from = 'FROM {node} AS signup_node ';
  // get access to the course field (so we can get the course nid to be used
  // in a separate query because this one is already too complex)
  $join_course = 'JOIN {content_type_course_signup} AS signup_course_field '.
                 'ON signup_node.vid = signup_course_field.vid ';
  // get access to the person field (so we can filter for the right person)
  $join_person = 'JOIN {content_field_person} AS signup_person_field '.
                 'ON signup_node.vid = signup_person_field.vid ';
  // get access to the session, linked from the course (so we can filter
  // for the right session)
  $join_session = 'JOIN {content_field_course_session} AS course_session_field '.
                  'ON course_session_field.nid = '.
                  'signup_course_field.field_signup_course_nid ';
  $where_type = 'WHERE signup_node.type=\'course_signup\' ';
  $where_person = 'AND signup_person_field.field_person_nid = '. $person_nid .' ';
  $where_session = 'AND course_session_field.field_course_session_nid = '. $session_nid;

  // get the course signups for this person
  $query = db_query($select . $from . $join_course . $join_person . $join_session .
                    $where_type . $where_person . $where_session);

  // each row is one course for this person from this session.
  while ($row = db_fetch_array($query)) {
    // now get the title of the course and the period it is in
    $course = db_fetch_array(db_query('SELECT course_node.title AS course, '.
                                      'course_period_field.field_course_period_nid AS period_nid '.
                                      'FROM {node} as course_node '.
                                      'JOIN {content_type_course} as course_period_field '.
                                      'ON course_node.vid = course_period_field.vid '.
                                      'WHERE course_node.nid = '. $row['course_nid']));
    $signups[$course['period_nid']]['course'] = $course['course'];
    $signups[$course['period_nid']]['signup'] = $row['signup_nid'];
  }

  // *****************************
  // NOW DO THE VOLUNTEER SIGNUPS FOR THE SAME PERSON

  $select = 'SELECT signup_fields.field_vol_job_nid AS job_nid, '.
            'signup_node.nid AS signup_nid, '.
            'signup_fields.field_vol_signup_course_nid AS course_nid ';
  $from = 'FROM {node} AS signup_node ';
  // get access to the signup fields
  $join_signup = 'JOIN {content_type_volunteer_signup} AS signup_fields '.
                 'ON signup_node.vid = signup_fields.vid ';
  // get access to the person field (so we can filter for the right person)
  $join_person = 'JOIN {content_field_person} AS signup_person_field '.
                 'ON signup_node.vid = signup_person_field.vid ';
  // get access to the session, linked from the course (so we can filter
  // for the right session)
  $join_session = 'JOIN {content_field_course_session} AS course_session_field '.
                  'ON course_session_field.nid = '.
                  'signup_fields.field_vol_signup_course_nid ';
  $where_type = 'WHERE signup_node.type=\'volunteer_signup\' ';
  $where_person = 'AND signup_person_field.field_person_nid = '. $person_nid .' ';
  $where_session = 'AND course_session_field.field_course_session_nid = '. $session_nid;

  $query = db_query($select . $from . $join_signup . $join_person . $join_session .
                    $where_type . $where_person . $where_session);

  // each row is one job for this person from this session.
  while ($row = db_fetch_array($query)) {
    // get the info about the course
    $course = db_fetch_array(db_query('SELECT course_node.title AS course, '.
                                      'course_period_field.field_course_period_nid AS period_nid '.
                                      'FROM {node} as course_node '.
                                      'JOIN {content_type_course} as course_period_field '.
                                      'ON course_node.vid = course_period_field.vid '.
                                      'WHERE course_node.nid = '. $row['course_nid']));
    $period = $course['period_nid'];
    $signups[$period]['course'] = $course['course'];
    $signups[$period]['signup'] = $row['signup_nid'];
    // and the info about the job
    $job = db_fetch_array(db_query('SELECT job_node.title AS job '.
                                   'FROM {node} as job_node '.
                                   'WHERE job_node.nid = '. $row['job_nid']));
    $signups[$period]['job'] = $job['job'];
  }
  return $signups;
}

/**
 * print the entire schedule page
 * @param array $signups the entire signups array, indexed first by family, then by person
 *        within that family, then by period, then with entries for course and optionally job
 *        if a period is missing, it means no assignment for that period (which is legal)
 * @return a nicely formatted listing of the information
 */
function _signups_print_page($signups) {
  $result = '<ul>';
  // loop through the families
  foreach ($signups as $family => $signups_for_family) {
    $result .= '<li>'. _signups_print_one_family($family, $signups_for_family) .'</li>';
  }
  $result .= '</ul>';
  return $result;
}

/**
 * print the schedule for one family
 * @param string $family the name of the family
 * @param array $signups the signup information for that family, indexed by person
 *        within that family, then by period, then with entries for course and optionally job
 *        if a period is missing, it means no assignment for that period (which is legal)
 * @return a nicely formatted html output of the schedule
 */
function _signups_print_one_family ($family, $signups) {
  $result = "<table border=\"1\">";
  $result .= '<tr><th></th><th>Before</th><th>Period 1</th><th>Period 2</th><th>Lunch</th>'.
             '<th>Period 3</th><th>Period 4</th><th>After</th></tr>';
  foreach ($signups as $person => $signups_for_person) {
    $result .= _signups_print_one_person($person, $signups_for_person);
  }
  $result .= '</table>';
  return $result;
}

/**
 * print the schedule for one person
 * @param string $name the name of the person
 * @param array $signups the array containing information about this person's signups, indexed
 *        by the period nid for each period (blank if there is no assignment for a given period)
 * @return a nicely formatted table row with the information for one person
 */
function _signups_print_one_person ($name, $signups) {
  $result = '<tr><th>'. $name .'</th>';
  // pass the signups array only for the given period: 489=Before
  $result .= _signups_print_one_period(489, $signups);
  // pass the signups array only for the given period: 490=Period 1
  $result .= _signups_print_one_period(490, $signups);
  // pass the signups array only for the given period: 492=Period 2
  $result .= _signups_print_one_period(492, $signups);
  // pass the signups array only for the given period: 494=Lunch
  $result .= _signups_print_one_period(494, $signups);
  // pass the signups array only for the given period: 496=Period 3
  $result .= _signups_print_one_period(496, $signups);
  // pass the signups array only for the given period: 498=Period 4
  $result .= _signups_print_one_period(498, $signups);
  // pass the signups array only for the given period: 499=After
  $result .= _signups_print_one_period(499, $signups);
  $result .= '</tr>';
  return $result;
}

/**
 * print one period for one family
 * @param period the period nid to be printed
 * @param array $signups the signups array for this person, indexed by period, then
 *              with elements for 'course' and optionally 'job'. A missing entry means
 *              there is no assignment for that period (which is legal, so handle
 *              it gracefully)
 * @return string the <td></td> enclosed information for this period
 */
function _signups_print_one_period ($period, $signups) {
  $result .= '<td>';
  if (isset($signups[$period])) {
    $result .= $signups[$period]['course'];
    if (isset($signups[$period]['job'])) {
      $result .= "\n<em>". $signups[$period]['job'] .'</em>';
    }
  }
  $result .= '</td>';
  return $result;
}